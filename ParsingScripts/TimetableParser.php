<?php

$sampleTimetableString = "===============================================================================
Database 12-13-2

Sessions for Mahmood,Usmaan_Ali (mahmoou1) module(s) 21111C 21111E 22712L 23111E 23111L 23421L 23421W 23422L 25111L 25212L 26121L 26122L 27112C 27112L 28112L 28411L 28411W Careers GSkills GSkills1 GSkills2 Tut1 Tut2

21111C sessions are at 4pm in room G23.
27112C sessions are at 5pm.
28112L sessions are at 11am in room G23.
Tut1 sessions are at 11am in room TutOff.
Tut2 sessions are at 3pm in room TutOff.

-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|Monday                           |Tuesday                     |Wednesday                         |Thursday                     |Friday                           |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|                                 |                            |[1.0]19/9 10am Careers All LecD   |20/9 9am Careers All D2AMD   |                                 |
|                                 |                            |[1.0]19/9 noon Careers All D1AMD  |20/9 2pm Careers All D2PMD   |                                 |
|                                 |                            |[1.0]19/9 2:30pm Careers All D1PMD|                             |                                 |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|                                 |                            |[1]26/9 Tut1 X6 01_PADP-1D        |                             |28/9 23421W I 1                  |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|                                 |[2]2/10 28411W J 1D         |                                  |4/10 9am 28411L F Unix 1D    |5/10 23421L I 1.1                |
|                                 |                            |                                  |4/10 11am 26121L H Unix 2D   |5/10 23111E K Ex1                |
|                                 |                            |                                  |4/10 21111C All Ex1D         |5/10 2pm Careers All CVD         |
|                                 |                            |                                  |4/10 11pm 26121L H submit 2e |                                 |
|                                 |                            |                                  |4/10 11pm 28411L F Moodle 1e |                                 |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[3]8/10 1pm 25111L G G23 1D      |                            |10/10 21111E J Ex1                |11/10 11am 26121L H Unix 3D  |12/10 23421W I 2                 |
|[3]8/10 11pm 25111L G submit 1e  |                            |10/10 Tut1 X6 02_Tut-1D           |11/10 21111C All Ex2D        |12/10 11am 23111L F G23 1        |
|                                 |                            |                                  |11/10 11pm 26121L H submit 3e|                                 |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|                                 |[4]16/10 28411W J 2D        |17/10 21111E J Ex2                |18/10 9am 28411L F Unix 2D   |19/10 23421L I 1.2D              |
|                                 |                            |                                  |18/10 11am 26121L H Unix 4D  |19/10 23111E K Ex2               |
|                                 |                            |                                  |18/10 21111C All Ex3D        |19/10 11pm 23111L F Moodle 1D    |
|                                 |                            |                                  |18/10 11pm 26121L H submit 4e|                                 |
|                                 |                            |                                  |18/10 11pm 28411L F Moodle 2e|                                 |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[5]22/10 1pm 25111L G G23 2.1    |                            |24/10 21111E J Ex3                |25/10 11am 26121L H Unix 5D  |26/10 23421W I 3                 |
|                                 |                            |                                  |25/10 21111C All Ex4D        |26/10 11am 23111L F G23 2        |
|                                 |                            |                                  |25/10 11pm 26121L H submit 5e|                                 |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|                                 |                            |                                  |                             |[6]2/11 5pm GSkills1 All EssayD  |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|                                 |[7]6/11 28411W J 3D         |7/11 21111E J Ex4                 |8/11 9am 28411L F Unix 3D    |9/11 23421L I 2.1                |
|                                 |                            |                                  |8/11 11am 26121L H Unix 6.1  |9/11 23111E K Ex3                |
|                                 |                            |                                  |8/11 21111C All Ex5D         |9/11 11pm 23111L F Moodle 2D     |
|                                 |                            |                                  |8/11 11pm 28411L F Moodle 3e |                                 |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[8]12/11 1pm 25111L G G23 2.2D   |                            |14/11 21111E J Ex5                |15/11 11am 26121L H Unix 6.2D|16/11 23421W I 4                 |
|[8]12/11 11pm 25111L G submit 2e |                            |14/11 Tut1 X6 03_Tut-2D           |15/11 21111C All Ex6D        |16/11 11am 23111L F G23 3        |
|                                 |                            |                                  |15/11 11pm 26121L H submit 6e|                                 |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|                                 |[9]20/11 28411W J 4D        |21/11 21111E J Ex6                |22/11 9am 28411L F Unix 4D   |23/11 23421L I 2.2D              |
|                                 |                            |                                  |22/11 11am 26121L H Unix 7D  |23/11 23111E K Ex4               |
|                                 |                            |                                  |22/11 21111C All Ex7D        |23/11 11pm 23111L F Moodle 3D    |
|                                 |                            |                                  |22/11 11pm 26121L H submit 7e|                                 |
|                                 |                            |                                  |22/11 11pm 28411L F Moodle 4e|                                 |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[10]26/11 1pm 25111L G G23 3.1   |                            |28/11 21111E J Ex7                |29/11 11am 26121L H Unix 8D  |30/11 23421W I 5                 |
|                                 |                            |28/11 Tut1 X6 04_Tut-3D           |29/11 21111C All Ex8D        |30/11 11am 23111L F G23 4        |
|                                 |                            |                                  |29/11 11pm 26121L H submit 8e|                                 |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|                                 |[11]4/12 28411W J 5D        |5/12 21111E J Ex8                 |6/12 9am 28411L F Unix 5D    |7/12 23421L I 3D                 |
|                                 |                            |                                  |6/12 11am 26121L H Unix 9.1  |7/12 23111E K Ex5                |
|                                 |                            |                                  |6/12 21111C All Ex9D         |7/12 11pm 23111L F Moodle 4D     |
|                                 |                            |                                  |6/12 11pm 28411L F Moodle 5e |                                 |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[12]10/12 1pm 25111L G G23 3.2D  |                            |19/11-12/12  GSkills1 All PresD   |13/12 11am 26121L H Unix 9.2D|14/12 23421W I 6                 |
|[12]10/12 11pm 25111L G submit 3e|                            |12/12 21111E J Ex9                |13/12 21111C All Ex10D       |14/12 11am 23111L F G23 5        |
|                                 |                            |12/12 Tut1 X6 05_Tut-4D           |13/12 11pm 26121L H submit 9e|                                 |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|                                 |                            |                                  |                             |[13]21/12 11pm 23111L F Moodle 5D|
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[2.1]28/1 10am 22712L I Toot1 1  |29/1 Tut2 X6 06_Tut-5D      |30/1 10am 22712L I Toot1 12       |                             |1/2 23422L F 1.1D                |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[2]4/2 10am 22712L I Toot1 2     |5/2 28112L I 1D             |6/2 10am 22712L I Toot1 13        |7/2 25212L G 1D              |29/1-8/2 GSkills2 All PresD      |
|                                 |                            |                                  |                             |8/2 9am 26122L H LF31 10.1       |
|                                 |                            |                                  |                             |8/2 23422L F 1.2D                |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[3]11/2 10am 22712L I Toot1 3    |12/2 11am 27112L H LF31 1D  |13/2 10am 22712L I Toot1 14D      |                             |15/2 9am 26122L H LF31 10.2      |
|                                 |12/2 Tut2 X6 07_Tut-6D      |                                  |                             |15/2 23422L F 1.3D               |
|                                 |12/2 11pm 27112L H - 1e     |                                  |                             |15/2 27112C All 1D               |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[4]18/2 10am 22712L I Toot1 4    |19/2 28112L I 2.1D          |20/2 10am 22712L I Toot1 15       |21/2 25212L G 2.1            |22/2 9am 26122L H LF31 10.3D     |
|                                 |                            |                                  |                             |22/2 23422L F 1.4D               |
|                                 |                            |                                  |                             |22/2 11pm 26122L H submit 10e    |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[5]25/2 10am 22712L I Toot1 5    |26/2 11am 27112L H LF31 2.1 |27/2 10am 22712L I Toot1 16D      |                             |1/3 9am 26122L H LF31 11.1       |
|                                 |26/2 Tut2 X6 08_Tut-7D      |                                  |                             |1/3 23422L F 2.1D                |
|                                 |                            |                                  |                             |1/3 27112C All 2D                |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[6]4/3 10am 22712L I Toot1 6     |5/3 28112L I 2.2            |6/3 10am 22712L I Toot1 17        |7/3 25212L G 2.2D            |8/3 9am 26122L H LF31 11.2       |
|                                 |                            |                                  |                             |8/3 23422L F 2.2D                |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[7]11/3 10am 22712L I Toot1 7    |12/3 11am 27112L H LF31 2.2D|13/3 10am 22712L I Toot1 18       |                             |15/3 9am 26122L H LF31 11.3D     |
|                                 |12/3 Tut2 X6 09_Tut-8D      |                                  |                             |15/3 23422L F 2.3D               |
|                                 |12/3 11pm 27112L H - 2e     |                                  |                             |15/3 27112C All 3D               |
|                                 |                            |                                  |                             |15/3 11pm 26122L H submit 11e    |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[8]18/3 10am 22712L I Toot1 8    |19/3 28112L I 2.3D          |20/3 10am 22712L I Toot1 19       |21/3 25212L G 3D             |22/3 9am 26122L H LF31 12D       |
|                                 |                            |                                  |                             |22/3 23422L F 2.4D               |
|                                 |                            |                                  |                             |22/3 11pm 26122L H submit 12e    |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[9]15/4 10am 22712L I Toot1 9    |16/4 11am 27112L H LF31 3D  |17/4 10am 22712L I Toot1 20       |                             |19/4 9am 26122L H LF31 13.1      |
|                                 |16/4 Tut2 X6 10_Tut-9D      |                                  |                             |19/4 23422L F 3.1D               |
|                                 |16/4 11pm 27112L H - 3e     |                                  |                             |19/4 27112C All 4D               |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[10]22/4 10am 22712L I Toot1 10  |23/4 28112L I 3D            |24/4 10am 22712L I Toot1 21       |25/4 25212L G 4D             |26/4 9am 26122L H LF31 13.2      |
|                                 |                            |                                  |                             |26/4 23422L F 3.2D               |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|[11]29/4 10am 22712L I Toot1 11  |30/4 11am 27112L H LF31 4D  |1/5 10am 22712L I Toot1 22        |                             |3/5 9am 26122L H LF31 13.3D      |
|                                 |30/4 11pm 27112L H - 4e     |                                  |                             |3/5 23422L F 3.3D                |
|                                 |                            |                                  |                             |3/5 5pm 22712L I - Ex7D          |
|                                 |                            |                                  |                             |3/5 5pm 22712L I - Ex9D          |
|                                 |                            |                                  |                             |3/5 27112C All 5D                |
|                                 |                            |                                  |                             |3/5 11pm 26122L H submit 13e     |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|                                 |                            |                                  |                             |[12]10/5 23422L F 3.4D           |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------


===============================================================================
End of query results";

class TimetableParser // extends Parser
{
    public function parse($inString)
    {
        $databaseStringArray = preg_split("/===============================================================================\n/", $inString, null, PREG_SPLIT_NO_EMPTY);
        array_pop($databaseStringArray); // remove the "End of query results" line

        $result = new TimetableResult();

        foreach ($databaseStringArray as $key => $database)
            $result->addDatabase($this->parseDatabase($database));

        return $result;

    }

    private function parseDatabase($inString)
    {
        $database = new TimetableDatabase();

        // get the database name
        preg_match("/(?:\s+(\S+))/", $inString, $matches);
        $rawDbName = $matches[1];
        $database->setDatabaseName($rawDbName);
        preg_match("/(\d+)-(\d+)-(\d)(.*)/", $rawDbName, $rawDbNameMatches);
        $database->setDatabaseParsedName("20" . $rawDbNameMatches[1] . "/20" . $rawDbNameMatches[2] . " - Year " . $rawDbNameMatches[3] . " - " . ($rawDbNameMatches[4] == "X" ? ("Overall") : "Coursework Only"));

        $weekByWeekArray = preg_split("/-------------------------------------------------------------------------------------------------------------------------------------------------------------------\n/", $inString, null, PREG_SPLIT_NO_EMPTY);

        // parse and fill SessionInfo
        preg_match_all("/(\w+ sessions are at \w+.*)/", $weekByWeekArray[0], $sessionInfoArray);
        $database->setSessionInfoList($sessionInfoArray[1]);

        array_shift($weekByWeekArray); // remove session info
        array_shift($weekByWeekArray); // remove mon-tue-wed-thu-fri line
        array_pop($weekByWeekArray); // remove empty final line

        // now do weeks into days
        foreach ($weekByWeekArray as $week) {
            // break line by line first
            $explodedWeekLineList = explode("\n", $week);
            array_pop($explodedWeekLineList); // remove empty last item
//            var_dump($explodedWeekLineList);

            $weekEntity = new TimetableWeek();
            // now explode and week line by line

            $monday = new TimetableWeekDay();
            $tuesday = new TimetableWeekDay();
            $wednesday = new TimetableWeekDay();
            $thursday = new TimetableWeekDay();
            $friday = new TimetableWeekDay();

            foreach ($explodedWeekLineList as $weekLine) {
                $explodedDayList = array_map('trim', explode('|', $weekLine));
                array_shift($explodedDayList); // remove empty first item
                array_pop($explodedDayList); // remove empty last item

                $daySession = $this->parseDaySession($explodedDayList[0]); // TimetableWeekDaySession
                $monday->addSession($daySession);

                $daySession = $this->parseDaySession($explodedDayList[1]); // TimetableWeekDaySession
                $tuesday->addSession($daySession);

                $daySession = $this->parseDaySession($explodedDayList[2]); // TimetableWeekDaySession
                $wednesday->addSession($daySession);

                $daySession = $this->parseDaySession($explodedDayList[3]); // TimetableWeekDaySession
                $thursday->addSession($daySession);

                $daySession = $this->parseDaySession($explodedDayList[4]); // TimetableWeekDaySession
                $friday->addSession($daySession);
            }

            $weekEntity->addDay($monday);
            $weekEntity->addDay($tuesday);
            $weekEntity->addDay($wednesday);
            $weekEntity->addDay($thursday);
            $weekEntity->addDay($friday);

            $database->addWeek($weekEntity);
        }
        return $database;
    } // parseDatabase

    // https://regex101.com/r/oE6jJ1/56
    private function parseDaySession($inString)
    {
        $daySession = new TimetableWeekDaySession();
        $daySession->setName($inString); // stores raw line
        if ($inString == "")
            return $daySession;


        $remainingString = $inString;

        // remove [semester.week] if it's there
        preg_match("/(\[\S+\])/", $remainingString, $squareBracketsMatches);
        if (!empty($squareBracketsMatches)) {
            $remainingString = substr($remainingString, strlen($squareBracketsMatches[0]));
        }
//        if ($remainingString != "") var_dump($remainingString);

        // remove date
        preg_match("/(\S*?(\d{1,2})\/(\d{1,2})\s+)/", $remainingString, $dateMatches);
        if (!empty($dateMatches)) {
            array_shift($dateMatches);
            $daySession->setDateDay($dateMatches[1]);
            $daySession->setDateMonth($dateMatches[2]);
            $remainingString = trim(substr($remainingString, strlen($dateMatches[0])));
        }
//        if ($remainingString != "") var_dump($remainingString);

        // remove time if it's there
        preg_match("/(\S*(?:a|p)m)\s+|(noon)\s+/", $remainingString, $timeMatches);
        if (!empty($timeMatches)) {
            $daySession->setTime($timeMatches[0]);
            $remainingString = trim(substr($remainingString, strlen($timeMatches[0])));
        }
//        if ($remainingString != "") var_dump($remainingString);

        // save three important items of info
        preg_match("/(\w+)\s+(\w+)\s(.*)/", $remainingString, $restMatches);
        if (!empty($restMatches)) {
            array_shift($restMatches); // remove complete match
            $daySession->setModule($restMatches[0]);
            $daySession->setGroup($restMatches[1]);
            $daySession->setInfo($restMatches[2]);
        }

//        var_dump($daySession);
        return $daySession;
    }

}


// all below this line is temp for testing purposes only
//include("Result.php");
//
//$parser = new TimetableParser();
//$result = $parser->parse($sampleTimetableString);
//var_dump($result);